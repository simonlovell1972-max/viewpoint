<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ViewPoint Pricing Calculator (HTML + JS)</title>
    <style>
      :root{
        --bg:#f8fafc; --card:#fff; --muted:#64748b; --text:#0f172a; --ring:#e2e8f0; --focus:#cbd5e1;
        --okbg:#ecfdf5; --okring:#a7f3d0; --errbg:#fff1f2; --erring:#fecdd3; --warnbg:#fffbeb; --warnring:#fde68a;
      }
      *{box-sizing:border-box}
      body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
      .wrap{max-width:1100px;margin:0 auto;padding:24px}
      header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
      header h1{margin:0;font-size:22px;font-weight:650;letter-spacing:-.02em}
      header p{margin:8px 0 0;color:var(--muted);font-size:13px}
      .actions{display:flex;gap:10px;align-items:center;margin-top:2px}
      .btn{
        border:1px solid var(--ring); background:#fff; color:#0f172a; padding:9px 12px; border-radius:12px;
        font-size:13px; font-weight:600; cursor:pointer;
      }
      .btn:focus{outline:none;box-shadow:0 0 0 3px var(--focus)}
      .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
      .grid{display:grid;gap:18px;grid-template-columns:1fr;margin-top:18px}
      @media (min-width:980px){.grid{grid-template-columns:1fr 1fr}}
      .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:18px;box-shadow:0 1px 1px rgba(15,23,42,.04)}
      .card h2{margin:0;font-size:16px;font-weight:650}
      label{display:block;font-size:13px;color:#334155}
      .help{display:block;margin-top:6px;font-size:12px;color:var(--muted)}
      input[type="number"], select, input[type="password"]{
        width:100%; margin-top:6px; padding:10px 11px; border:1px solid var(--ring); border-radius:14px; outline:none;
        font-size:13px; background:#fff;
      }
      input[type="number"]:focus, select:focus, input[type="password"]:focus{box-shadow:0 0 0 3px var(--focus)}
      .row2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
      .subcard{background:#f8fafc;border:1px solid var(--ring);border-radius:14px;padding:14px;margin-top:12px}
      .subcard .title{font-size:13px;font-weight:600}
      .kpis{margin-top:12px;display:grid;gap:12px;grid-template-columns:1fr 1fr}
      .kpi{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:12px}
      .kpi .k{font-size:11px;color:var(--muted)}
      .kpi .v{margin-top:6px;font-size:14px;font-weight:650}
      .big{font-size:20px!important}
      .muted{color:var(--muted);font-size:12px}
      .foot{margin-top:16px;font-size:12px;color:var(--muted)}
      .table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--ring);background:#fff;margin-top:12px}
      .table th,.table td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--ring);text-align:left;vertical-align:top}
      .table th{background:#f1f5f9;font-size:12px;color:#334155}
      .table tr:last-child td{border-bottom:0}
      .right{text-align:right}
      .strong{font-weight:700}
      .status{margin-top:12px;border-radius:14px;border:1px solid;padding:12px;font-size:13px}
      .status.ok{background:var(--okbg);border-color:var(--okring)}
      .status.err{background:var(--errbg);border-color:var(--erring)}
      .status.warn{background:var(--warnbg);border-color:var(--warnring)}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      details{margin-top:12px}
      details summary{cursor:pointer;font-weight:650;font-size:13px;color:#0f172a}
      .formgrid{display:grid;gap:10px;margin-top:10px}
      .tight{margin-top:6px}
      .inlineRow{display:flex;gap:10px;align-items:flex-end}
      .inlineRow > div{flex:1}
      .smallBtn{padding:9px 10px;border-radius:12px;border:1px solid var(--ring);background:#fff;font-weight:650;cursor:pointer}
      .smallBtn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
      .smallBtn:focus{outline:none;box-shadow:0 0 0 3px var(--focus)}
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>ViewPoint Pricing Calculator</h1>
          <p>
            Assumes <b>1 reporting node included</b> in the Platform Licence. Enter extra reporting nodes only.
            Hardware is one-off and never discounted. Discounts apply to software only (Platform + Nodes).
          </p>
        </div>
        <div class="actions">
          <button class="btn" id="resetBtn" type="button">Reset</button>
          <button class="btn primary" id="pricingBtn" type="button">Edit pricing</button>
        </div>
      </header>

      <div class="grid">
        <!-- Inputs -->
        <section class="card">
          <h2>Inputs</h2>

          <div class="row2" style="margin-top:12px">
            <label>
              Extra reporting nodes
              <input id="extraNodes" type="number" min="0" step="1" value="0" />
              <span class="help">Total reporting nodes = 1 included + extra nodes.</span>
            </label>

            <label>
              Contract term
              <select id="termMonths">
                <option value="12" selected>12 months (0%)</option>
                <option value="24">24 months (30%)</option>
                <option value="36">36 months (40%)</option>
              </select>
              <span class="help">Discount applies to software only (Platform + Nodes).</span>
            </label>
          </div>

          <div class="subcard">
            <div class="title">Hardware (one-off)</div>

            <div class="row2" style="margin-top:10px">
              <label>
                Pulses
                <input id="pulses" type="number" min="0" step="1" value="0" />
                <span class="help">£<span id="pricePulseLbl">550</span> each</span>
              </label>
              <label>
                Tag Boards
                <input id="tagBoards" type="number" min="0" step="1" value="0" />
                <span class="help">£<span id="priceTagLbl">140</span> each</span>
              </label>
            </div>

            <label style="margin-top:10px">
              Basic QR Codes
              <input id="basicQrs" type="number" min="0" step="1" value="0" />
              <span class="help">£<span id="priceQrLbl">0</span> each (included for completeness; does not affect totals)</span>
            </label>
          </div>

          <div class="subcard">
            <div class="title">Included assumptions</div>
            <div class="muted tight">
              Platform Licence includes <b>1 reporting node</b>. Chargeable nodes are your <b>extra nodes</b>.
              Retroactive node tiers apply to the total chargeable nodes and set a single price per node.
            </div>
          </div>
        </section>

        <!-- Outputs -->
        <section class="card">
          <h2>Outputs</h2>

          <div class="subcard" style="margin-top:12px">
            <div class="title">Software</div>

            <div class="kpis">
              <div class="kpi">
                <div class="k">Platform Licence (annual)</div>
                <div class="v" id="platformFee">£0.00</div>
              </div>

              <div class="kpi">
                <div class="k">Chargeable Nodes</div>
                <div class="v" id="chargeableNodes">0</div>
                <div class="muted" id="chargeableExplain"></div>
              </div>

              <div class="kpi">
                <div class="k">Tier price per chargeable node</div>
                <div class="v" id="tierPrice">£0.00</div>
                <div class="muted">Retroactive (applies to all chargeable nodes)</div>
              </div>

              <div class="kpi">
                <div class="k">Total annual software (full price)</div>
                <div class="v" id="annualSoftwareFull">£0.00</div>
              </div>

              <div class="kpi">
                <div class="k">Discount applied</div>
                <div class="v" id="discountApplied">£0.00</div>
                <div class="muted" id="discountExplain"></div>
              </div>

              <div class="kpi">
                <div class="k">Discounted annual software</div>
                <div class="v" id="annualSoftwareDiscounted">£0.00</div>
              </div>
            </div>
          </div>

          <div class="subcard">
            <div class="title">Hardware (one-off)</div>

            <div class="kpis">
              <div class="kpi">
                <div class="k">One-off hardware total</div>
                <div class="v" id="hardwareTotal">£0.00</div>
                <div class="muted" id="hardwareBreakdown"></div>
              </div>

              <div class="kpi">
                <div class="k">Total Year 1 investment</div>
                <div class="v big" id="totalYear1">£0.00</div>
                <div class="muted">(Discounted software + one-off hardware)</div>
              </div>
            </div>
          </div>

          <div class="subcard">
            <div class="title">Contract costs by year</div>
            <table class="table" aria-label="Contract cost breakdown">
              <thead>
                <tr>
                  <th style="width: 35%;">Period</th>
                  <th class="right">Software</th>
                  <th class="right">Hardware</th>
                  <th class="right">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Year 1</td>
                  <td class="right" id="y1Software">£0.00</td>
                  <td class="right" id="y1Hardware">£0.00</td>
                  <td class="right strong" id="y1Total">£0.00</td>
                </tr>
                <tr>
                  <td>Year 2</td>
                  <td class="right" id="y2Software">£0.00</td>
                  <td class="right" id="y2Hardware">£0.00</td>
                  <td class="right" id="y2Total">£0.00</td>
                </tr>
                <tr>
                  <td>Year 3</td>
                  <td class="right" id="y3Software">£0.00</td>
                  <td class="right" id="y3Hardware">£0.00</td>
                  <td class="right" id="y3Total">£0.00</td>
                </tr>
                <tr>
                  <td class="strong">Total contract cost</td>
                  <td class="right" id="contractSoftwareTotal">£0.00</td>
                  <td class="right" id="contractHardwareTotal">£0.00</td>
                  <td class="right strong" id="contractTotal">£0.00</td>
                </tr>
              </tbody>
            </table>
            <div class="muted" style="margin-top:8px">
              Assumes the discounted annual software fee repeats each year during the term; hardware is one-off in Year 1 only.
            </div>
          </div>

          <!-- Pricing editor (passworded) -->
          <details id="pricingEditor">
            <summary>Pricing admin (password required)</summary>

            <div class="status warn">
              This is a convenience feature for quick pricing tweaks. It’s only lightly protected (not secure).
            </div>

            <div class="inlineRow">
              <div>
                <label>
                  Password
                  <input id="adminPwd" type="password" placeholder="Enter password" />
                  <span class="help">Password: <span class="mono">CRT2012</span></span>
                </label>
              </div>
              <button class="smallBtn" id="unlockBtn" type="button">Unlock</button>
            </div>

            <div id="adminLockedMsg" class="muted" style="margin-top:10px">
              Locked. Enter the password and click Unlock to edit pricing.
            </div>

            <div id="adminPanel" style="display:none;">
              <div class="subcard" style="margin-top:12px">
                <div class="title">Software pricing</div>
                <div class="row2" style="margin-top:10px">
                  <label>
                    Platform Licence (per year)
                    <input id="pricePlatform" type="number" min="0" step="1" />
                  </label>
                  <label>
                    12-month discount rate (0–1)
                    <input id="disc12" type="number" min="0" max="1" step="0.01" />
                  </label>
                </div>
                <div class="row2" style="margin-top:10px">
                  <label>
                    24-month discount rate (0–1)
                    <input id="disc24" type="number" min="0" max="1" step="0.01" />
                  </label>
                  <label>
                    36-month discount rate (0–1)
                    <input id="disc36" type="number" min="0" max="1" step="0.01" />
                  </label>
                </div>

                <div class="title" style="margin-top:12px">Retroactive node tiers (chargeable nodes)</div>
                <div class="muted tight">Each tier sets a single price per node for all chargeable nodes once the tier is reached.</div>

                <table class="table" style="margin-top:10px">
                  <thead>
                    <tr>
                      <th>Min</th>
                      <th>Max</th>
                      <th class="right">Price per node</th>
                    </tr>
                  </thead>
                  <tbody id="tiersTableBody"></tbody>
                </table>
              </div>

              <div class="subcard">
                <div class="title">Hardware pricing (one-off)</div>
                <div class="row2" style="margin-top:10px">
                  <label>
                    Pulse unit price
                    <input id="pricePulse" type="number" min="0" step="1" />
                  </label>
                  <label>
                    Tag Board unit price
                    <input id="priceTag" type="number" min="0" step="1" />
                  </label>
                </div>
                <div class="row2" style="margin-top:10px">
                  <label>
                    Basic QR unit price
                    <input id="priceQr" type="number" min="0" step="1" />
                  </label>
                  <div></div>
                </div>
              </div>

              <div class="inlineRow">
                <button class="smallBtn primary" id="applyPricingBtn" type="button">Apply pricing</button>
                <button class="smallBtn" id="resetPricingBtn" type="button">Reset pricing to defaults</button>
              </div>

              <div id="applyMsg"></div>
            </div>
          </details>
        </section>
      </div>

      <div class="foot" id="footNote"></div>
    </div>

    <script>
      // ---------------------------
      // Default Pricing (baseline)
      // ---------------------------
      const DEFAULT_PRICES = {
        platformPerYear: 849,
        hardware: { pulse: 550, tagBoard: 140, basicQr: 0 },
        tiersRetroactive: [
          { min: 1, max: 5, price: 350 },
          { min: 6, max: 20, price: 325 },
          { min: 21, max: 40, price: 300 },
          { min: 41, max: 75, price: 260 },
          { min: 76, max: 100, price: 230 },
          { min: 101, max: Infinity, price: 200 },
        ],
        discountByTerm: { 12: 0, 24: 0.3, 36: 0.4 },
      };

      // Live prices (mutable by admin panel)
      let PRICES = deepClone(DEFAULT_PRICES);

      // In-memory "admin" state (light protection; not secure)
      let adminUnlocked = false;
      const ADMIN_PASSWORD = "CRT2012";

      // ---------------------------
      // Helpers
      // ---------------------------
      function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

      function clampInt(value, min = 0) {
        const n = Number(value);
        if (!Number.isFinite(n)) return min;
        return Math.max(min, Math.trunc(n));
      }

      function clampNum(value, min = 0, max = Infinity) {
        const n = Number(value);
        if (!Number.isFinite(n)) return min;
        return Math.max(min, Math.min(max, n));
      }

      function formatGBP(value) {
        const n = Number(value) || 0;
        return n.toLocaleString("en-GB", {
          style: "currency",
          currency: "GBP",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function tierPriceForChargeableNodes(chargeableNodes) {
        if (chargeableNodes <= 0) return 0;
        const tier = PRICES.tiersRetroactive.find(
          (t) => chargeableNodes >= t.min && chargeableNodes <= t.max
        );
        return tier ? Number(tier.price) : 0;
      }

      function yearsForTerm(termMonths) {
        const t = clampInt(termMonths, 12);
        return Math.max(1, Math.round(t / 12)); // 12->1, 24->2, 36->3
      }

      // ---------------------------
      // DOM refs
      // ---------------------------
      const els = {
        // header actions
        resetBtn: document.getElementById("resetBtn"),
        pricingBtn: document.getElementById("pricingBtn"),

        // inputs
        extraNodes: document.getElementById("extraNodes"),
        termMonths: document.getElementById("termMonths"),
        pulses: document.getElementById("pulses"),
        tagBoards: document.getElementById("tagBoards"),
        basicQrs: document.getElementById("basicQrs"),

        // price labels
        pricePulseLbl: document.getElementById("pricePulseLbl"),
        priceTagLbl: document.getElementById("priceTagLbl"),
        priceQrLbl: document.getElementById("priceQrLbl"),

        // outputs
        platformFee: document.getElementById("platformFee"),
        chargeableNodes: document.getElementById("chargeableNodes"),
        chargeableExplain: document.getElementById("chargeableExplain"),
        tierPrice: document.getElementById("tierPrice"),
        annualSoftwareFull: document.getElementById("annualSoftwareFull"),
        discountApplied: document.getElementById("discountApplied"),
        discountExplain: document.getElementById("discountExplain"),
        annualSoftwareDiscounted: document.getElementById("annualSoftwareDiscounted"),
        hardwareTotal: document.getElementById("hardwareTotal"),
        hardwareBreakdown: document.getElementById("hardwareBreakdown"),
        totalYear1: document.getElementById("totalYear1"),

        // contract breakdown
        y1Software: document.getElementById("y1Software"),
        y1Hardware: document.getElementById("y1Hardware"),
        y1Total: document.getElementById("y1Total"),
        y2Software: document.getElementById("y2Software"),
        y2Hardware: document.getElementById("y2Hardware"),
        y2Total: document.getElementById("y2Total"),
        y3Software: document.getElementById("y3Software"),
        y3Hardware: document.getElementById("y3Hardware"),
        y3Total: document.getElementById("y3Total"),
        contractSoftwareTotal: document.getElementById("contractSoftwareTotal"),
        contractHardwareTotal: document.getElementById("contractHardwareTotal"),
        contractTotal: document.getElementById("contractTotal"),

        footNote: document.getElementById("footNote"),

        // admin panel
        pricingEditor: document.getElementById("pricingEditor"),
        adminPwd: document.getElementById("adminPwd"),
        unlockBtn: document.getElementById("unlockBtn"),
        adminLockedMsg: document.getElementById("adminLockedMsg"),
        adminPanel: document.getElementById("adminPanel"),
        pricePlatform: document.getElementById("pricePlatform"),
        disc12: document.getElementById("disc12"),
        disc24: document.getElementById("disc24"),
        disc36: document.getElementById("disc36"),
        tiersTableBody: document.getElementById("tiersTableBody"),
        pricePulse: document.getElementById("pricePulse"),
        priceTag: document.getElementById("priceTag"),
        priceQr: document.getElementById("priceQr"),
        applyPricingBtn: document.getElementById("applyPricingBtn"),
        resetPricingBtn: document.getElementById("resetPricingBtn"),
        applyMsg: document.getElementById("applyMsg"),
      };

      // ---------------------------
      // UI: Pricing editor wiring
      // ---------------------------
      function openPricingEditor() {
        els.pricingEditor.open = true;
        els.pricingEditor.scrollIntoView({ behavior: "smooth", block: "start" });
        els.adminPwd.focus();
      }

      function setAdminUnlocked(unlocked) {
        adminUnlocked = unlocked;
        els.adminPanel.style.display = unlocked ? "block" : "none";
        els.adminLockedMsg.style.display = unlocked ? "none" : "block";
        if (unlocked) {
          hydratePricingEditorFields();
          els.applyMsg.innerHTML = `<div class="status ok"><b>Unlocked.</b> You can now edit and apply pricing.</div>`;
        } else {
          els.applyMsg.innerHTML = "";
        }
      }

      function hydratePricingEditorFields() {
        // platform + discounts
        els.pricePlatform.value = PRICES.platformPerYear;
        els.disc12.value = PRICES.discountByTerm["12"] ?? 0;
        els.disc24.value = PRICES.discountByTerm["24"] ?? 0.3;
        els.disc36.value = PRICES.discountByTerm["36"] ?? 0.4;

        // hardware
        els.pricePulse.value = PRICES.hardware.pulse;
        els.priceTag.value = PRICES.hardware.tagBoard;
        els.priceQr.value = PRICES.hardware.basicQr;

        // tiers table (editable prices)
        els.tiersTableBody.innerHTML = "";
        PRICES.tiersRetroactive.forEach((t, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input class="tierMin" type="number" min="0" step="1" value="${t.min}" data-idx="${idx}" style="width:100%; margin-top:0; padding:8px 10px; border-radius:10px; border:1px solid var(--ring)" /></td>
            <td><input class="tierMax" type="number" min="0" step="1" value="${t.max === Infinity ? "" : t.max}" placeholder="∞" data-idx="${idx}" style="width:100%; margin-top:0; padding:8px 10px; border-radius:10px; border:1px solid var(--ring)" /></td>
            <td class="right"><input class="tierPrice" type="number" min="0" step="1" value="${t.price}" data-idx="${idx}" style="width:100%; margin-top:0; padding:8px 10px; border-radius:10px; border:1px solid var(--ring); text-align:right" /></td>
          `;
          els.tiersTableBody.appendChild(tr);
        });
      }

      function applyPricingFromEditor() {
        if (!adminUnlocked) {
          els.applyMsg.innerHTML = `<div class="status err"><b>Locked.</b> Enter password and click Unlock first.</div>`;
          return;
        }

        // platform
        const platform = clampInt(els.pricePlatform.value, 0);

        // discounts
        const d12 = clampNum(els.disc12.value, 0, 1);
        const d24 = clampNum(els.disc24.value, 0, 1);
        const d36 = clampNum(els.disc36.value, 0, 1);

        // hardware
        const hp = clampInt(els.pricePulse.value, 0);
        const ht = clampInt(els.priceTag.value, 0);
        const hq = clampInt(els.priceQr.value, 0);

        // tiers (read row inputs)
        const mins = Array.from(document.querySelectorAll(".tierMin"));
        const maxs = Array.from(document.querySelectorAll(".tierMax"));
        const prices = Array.from(document.querySelectorAll(".tierPrice"));

        const tiers = mins.map((minEl, i) => {
          const min = clampInt(minEl.value, 0);
          const maxRaw = maxs[i]?.value;
          const max = (maxRaw === "" || maxRaw === null || maxRaw === undefined) ? Infinity : clampInt(maxRaw, 0);
          const price = clampInt(prices[i]?.value, 0);
          return { min, max, price };
        }).sort((a,b) => a.min - b.min);

        // basic sanity: ensure there is an Infinity tier at end
        const hasInfinity = tiers.some(t => t.max === Infinity);
        if (!hasInfinity) tiers.push({ min: 101, max: Infinity, price: tiers[tiers.length-1]?.price ?? 0 });

        PRICES = {
          platformPerYear: platform,
          hardware: { pulse: hp, tagBoard: ht, basicQr: hq },
          tiersRetroactive: tiers,
          discountByTerm: { 12: d12, 24: d24, 36: d36 },
        };

        syncPriceLabels();
        recalcAndRender();

        els.applyMsg.innerHTML = `<div class="status ok"><b>Applied.</b> New pricing is now active in the calculator.</div>`;
      }

      function resetPricingToDefaults() {
        PRICES = deepClone(DEFAULT_PRICES);
        hydratePricingEditorFields();
        syncPriceLabels();
        recalcAndRender();
        els.applyMsg.innerHTML = `<div class="status ok"><b>Reset.</b> Pricing restored to default values.</div>`;
      }

      function syncPriceLabels() {
        els.pricePulseLbl.textContent = PRICES.hardware.pulse;
        els.priceTagLbl.textContent = PRICES.hardware.tagBoard;
        els.priceQrLbl.textContent = PRICES.hardware.basicQr;

        els.footNote.textContent =
          `Prices: Platform £${PRICES.platformPerYear}/yr (includes 1 reporting node), retroactive node tiers apply to chargeable nodes only, discounts apply to software only, hardware is one-off.`;
      }

      // ---------------------------
      // Calculator
      // ---------------------------
      function recalcAndRender() {
        // Inputs
        const extraNodes = clampInt(els.extraNodes.value, 0);
        const totalNodes = 1 + extraNodes;           // ALWAYS includes 1 bundled
        const chargeableNodes = extraNodes;          // Chargeable == extra nodes

        const pulses = clampInt(els.pulses.value, 0);
        const tagBoards = clampInt(els.tagBoards.value, 0);
        const basicQrs = clampInt(els.basicQrs.value, 0);

        const term = clampInt(els.termMonths.value, 12);
        const years = yearsForTerm(term);

        // Software
        const tierPrice = tierPriceForChargeableNodes(chargeableNodes);
        const annualSoftwareFull = PRICES.platformPerYear + (chargeableNodes * tierPrice);

        const discountRate = PRICES.discountByTerm[String(term)] ?? 0;
        const discountApplied = annualSoftwareFull * discountRate;
        const annualSoftwareDiscounted = annualSoftwareFull - discountApplied;

        // Hardware
        const hardwareTotal =
          pulses * PRICES.hardware.pulse +
          tagBoards * PRICES.hardware.tagBoard +
          basicQrs * PRICES.hardware.basicQr;

        const totalYear1 = annualSoftwareDiscounted + hardwareTotal;

        // Outputs (main)
        els.platformFee.textContent = formatGBP(PRICES.platformPerYear);

        els.chargeableNodes.textContent = String(chargeableNodes);
        els.chargeableExplain.textContent = `Total nodes (${totalNodes}) = 1 included + ${extraNodes} extra`;

        els.tierPrice.textContent = formatGBP(tierPrice);
        els.annualSoftwareFull.textContent = formatGBP(annualSoftwareFull);

        els.discountApplied.textContent = formatGBP(discountApplied);
        els.discountExplain.textContent = `${Math.round(discountRate * 100)}% (${term} months)`;

        els.annualSoftwareDiscounted.textContent = formatGBP(annualSoftwareDiscounted);

        els.hardwareTotal.textContent = formatGBP(hardwareTotal);
        els.hardwareBreakdown.innerHTML =
          `Pulses: ${pulses} × ${formatGBP(PRICES.hardware.pulse)}<br>` +
          `Tag Boards: ${tagBoards} × ${formatGBP(PRICES.hardware.tagBoard)}<br>` +
          `Basic QR: ${basicQrs} × ${formatGBP(PRICES.hardware.basicQr)}`;

        els.totalYear1.textContent = formatGBP(totalYear1);

        // Contract breakdown
        const y1Software = annualSoftwareDiscounted;
        const y1Hardware = hardwareTotal;
        const y1Total = y1Software + y1Hardware;

        const y2Software = years >= 2 ? annualSoftwareDiscounted : 0;
        const y2Total = y2Software;

        const y3Software = years >= 3 ? annualSoftwareDiscounted : 0;
        const y3Total = y3Software;

        const contractSoftwareTotal = annualSoftwareDiscounted * years;
        const contractHardwareTotal = hardwareTotal;
        const contractTotal = contractSoftwareTotal + contractHardwareTotal;

        els.y1Software.textContent = formatGBP(y1Software);
        els.y1Hardware.textContent = formatGBP(y1Hardware);
        els.y1Total.textContent = formatGBP(y1Total);

        els.y2Software.textContent = formatGBP(y2Software);
        els.y2Hardware.textContent = formatGBP(0);
        els.y2Total.textContent = formatGBP(y2Total);

        els.y3Software.textContent = formatGBP(y3Software);
        els.y3Hardware.textContent = formatGBP(0);
        els.y3Total.textContent = formatGBP(y3Total);

        els.contractSoftwareTotal.textContent = formatGBP(contractSoftwareTotal);
        els.contractHardwareTotal.textContent = formatGBP(contractHardwareTotal);
        els.contractTotal.textContent = formatGBP(contractTotal);
      }

      function resetInputsToDefaults() {
        els.extraNodes.value = 0;
        els.termMonths.value = "12";
        els.pulses.value = 0;
        els.tagBoards.value = 0;
        els.basicQrs.value = 0;
        recalcAndRender();
      }

      // ---------------------------
      // Events
      // ---------------------------
      ["input", "change"].forEach((evt) => {
        els.extraNodes.addEventListener(evt, recalcAndRender);
        els.termMonths.addEventListener(evt, recalcAndRender);
        els.pulses.addEventListener(evt, recalcAndRender);
        els.tagBoards.addEventListener(evt, recalcAndRender);
        els.basicQrs.addEventListener(evt, recalcAndRender);
      });

      els.resetBtn.addEventListener("click", () => resetInputsToDefaults());
      els.pricingBtn.addEventListener("click", () => openPricingEditor());

      els.unlockBtn.addEventListener("click", () => {
        const pwd = (els.adminPwd.value || "").trim();
        if (pwd === ADMIN_PASSWORD) {
          setAdminUnlocked(true);
          // clear password box for tidiness
          els.adminPwd.value = "";
        } else {
          setAdminUnlocked(false);
          els.applyMsg.innerHTML = `<div class="status err"><b>Wrong password.</b> Try again.</div>`;
        }
      });

      els.applyPricingBtn.addEventListener("click", () => applyPricingFromEditor());
      els.resetPricingBtn.addEventListener("click", () => resetPricingToDefaults());

      // ---------------------------
      // Init
      // ---------------------------
      (function init(){
        syncPriceLabels();
        resetInputsToDefaults();
        setAdminUnlocked(false);
      })();
    </script>
  </body>
</html>
