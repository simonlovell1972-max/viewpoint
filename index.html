let PRICES = deepClone(DEFAULT_PRICES);

function normalisePricingJson(data) {
  const safe = deepClone(DEFAULT_PRICES);

  if (!data || typeof data !== "object") return safe;

  // platform
  if (Number.isFinite(Number(data.platformPerYear))) {
    safe.platformPerYear = Math.max(0, Math.trunc(Number(data.platformPerYear)));
  }

  // hardware
  if (data.hardware && typeof data.hardware === "object") {
    ["pulse", "tagBoard", "basicQr"].forEach((k) => {
      if (Number.isFinite(Number(data.hardware[k]))) {
        safe.hardware[k] = Math.max(0, Math.trunc(Number(data.hardware[k])));
      }
    });
  }

  // discounts
  if (data.discountByTerm && typeof data.discountByTerm === "object") {
    ["12", "24", "36"].forEach((k) => {
      const v = Number(data.discountByTerm[k]);
      if (Number.isFinite(v)) safe.discountByTerm[k] = Math.max(0, Math.min(1, v));
    });
  }

  // tiers
  if (Array.isArray(data.tiersRetroactive) && data.tiersRetroactive.length) {
    const tiers = data.tiersRetroactive
      .map((t) => {
        const min = Math.max(0, Math.trunc(Number(t.min)));
        const max =
          t.max === null || t.max === undefined || t.max === ""
            ? Infinity
            : Math.max(0, Math.trunc(Number(t.max)));
        const price = Math.max(0, Math.trunc(Number(t.price)));
        return { min, max, price };
      })
      .filter((t) => Number.isFinite(t.min) && Number.isFinite(t.price))
      .sort((a, b) => a.min - b.min);

    // ensure last tier is Infinity
    if (!tiers.some((t) => t.max === Infinity)) {
      tiers.push({ min: 101, max: Infinity, price: tiers[tiers.length - 1]?.price ?? 0 });
    }
    safe.tiersRetroactive = tiers;
  }

  return safe;
}

async function loadPricingFromFile() {
  try {
    const res = await fetch("./pricing.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    PRICES = normalisePricingJson(data);
  } catch (e) {
    // fallback to DEFAULT_PRICES already set
    console.warn("Pricing file not loaded; using defaults.", e);
    PRICES = deepClone(DEFAULT_PRICES);
  }

  // refresh UI + calculations after loading
  syncPriceLabels();
  recalcAndRender();
}

// call this during init:
loadPricingFromFile();